<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WanderScript v.1.1 (Auto-Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #0B1120; 
            background-image: radial-gradient(rgba(34, 211, 238, 0.1) 1px, transparent 1px), radial-gradient(rgba(34, 211, 238, 0.1) 1px, #0B1120 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:active:not(:disabled) { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(45deg, #22D3EE, #0891B2); color: white; box-shadow: 0 4px 15px rgba(34, 211, 238, 0.2); }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(45deg, #0891B2, #0e7490); box-shadow: 0 6px 20px rgba(34, 211, 238, 0.3); }
        .btn-success { background-color: #16A34A; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #15803D; }
        .btn-secondary { background-color: #374151; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4B5563; }
        .btn-ai { background: linear-gradient(45deg, #0891B2, #0d9488); color: white; }
        .btn-ai:hover:not(:disabled) { background: linear-gradient(45deg, #06b6d4, #0f766e); }
        .btn-prompt-canva { background-color: #0891b2; color: white; }
        .btn-prompt-canva:hover:not(:disabled) { background-color: #0e7490; }
        .btn-copy { background-color: #4B5563; color: #D1D5DB; }
        .btn-copy:hover:not(:disabled) { background-color: #6B7280; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loader, .inline-loader {
            border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid #22D3EE;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        .inline-loader {
            width: 20px; height: 20px; border-width: 2px;
            border-top-color: white; border-left-color: white; border-right-color: white; border-bottom-color: transparent;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #22D3EE; color: #67e8f9; }
        .prompt-output { 
            font-family: 'Roboto Mono', monospace;
            background-color: #111827; 
            border: 1px solid #374151; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-size: 0.9rem;
            line-height: 1.6;
            color: #e5e7eb;
        }
        .glass-card {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid rgba(55, 65, 81, 0.5);
        }
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(10, 10, 10, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .custom-modal-overlay.visible { display: flex; opacity: 1; pointer-events: auto; }
        .custom-modal-content {
            background-color: #1f2937;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 90%;
            width: 500px;
            border: 1px solid #374151;
        }
        .action-dna-tag { cursor: pointer; transition: all 0.2s ease; }
        .action-dna-tag.selected { background-color: #0891B2; color: white; border-color: #0e7490; }
        .suggestion-list { list-style: none; padding-left: 0; }
        .suggestion-list li { display: flex; align-items: flex-start; gap: 0.5rem; }
        .futuristic-text-glow { text-shadow: 0 0 8px rgba(34, 211, 238, 0.5); }
    </style>
</head>
<body class="text-gray-200 antialiased">

    <div id="app-wrapper" class="fade-in">
        <header class="text-center py-4 px-4 md:px-8 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto flex justify-between items-center glass-card p-3">
                <div class="flex items-center gap-3">
                    <img src="https://placehold.co/96x96/0891B2/FFFFFF?text=WS&font=poppins" alt="Logo" class="h-10 w-10 rounded-full">
                    <h1 class="text-xl md:text-2xl font-extrabold tracking-tight">
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-sky-400 futuristic-text-glow">WanderScript v.1.1</span>
                    </h1>
                </div>
                <div class="flex items-center gap-2 md:gap-3">
                    <button id="importProjectBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg text-sm">Impor JSON</button>
                    <button id="exportProjectBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg text-sm">Ekspor ke JSON</button>
                    <button id="resetProjectBtn" class="btn btn-primary font-semibold py-2 px-4 rounded-lg text-sm">PROYEK BARU</button>
                    <button id="openSettingsBtn" class="btn btn-secondary p-2 rounded-lg">‚öôÔ∏è</button>
                </div>
            </div>
        </header>

        <div class="flex flex-col md:flex-row max-w-7xl mx-auto gap-6 p-4 md:p-6">
            <aside class="w-full md:w-1/3 lg:w-1/4 space-y-6 flex-shrink-0">
                <div id="characterSection" class="glass-card">
                    <div class="p-4"><h2 class="text-xl font-bold">Host / Blogger</h2></div>
                    <div class="p-4 border-t border-gray-700 space-y-4">
                        <p class="text-sm text-gray-400">Buat host/blogger yang akan memandu vlog Anda.</p>
                        <button id="openAddCharModalBtn" class="btn btn-ai font-semibold py-2 px-4 rounded-lg w-full">Buat Host Baru</button>
                        <div class="pt-4 mt-4 border-t border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-400 mb-3 text-center">Host Siap Pakai</h3>
                            <div id="templateCharList" class="space-y-2"></div>
                        </div>
                        <div class="pt-4 mt-4 border-t border-gray-700">
                             <h3 class="text-sm font-semibold text-gray-400 mb-2">Host Anda:</h3>
                             <div id="charListContainer" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>
                <div id="directingSection" class="glass-card">
                    <div class="p-4"><h2 class="text-xl font-bold">Arahan Vlog</h2></div>
                    <div class="p-4 border-t border-gray-700 space-y-4">
                        <p class="text-sm text-gray-400">Atur nuansa dan lokasi vlog.</p>
                         <div class="p-3 bg-cyan-900/50 border border-cyan-500/50 rounded-lg text-center">
                             <p class="font-bold text-cyan-300">Gaya Visual üé®</p>
                             <p class="text-xs text-cyan-400">Vlog Perjalanan (Lucu & Informatif).</p>
                         </div>
                         <div id="narratorStyleLock" class="p-3 bg-cyan-900/50 border border-cyan-500/50 rounded-lg text-center mt-4">
                             <p class="font-bold text-cyan-300">Gaya Audio üéôÔ∏è</p>
                             <p id="selectedNarratorStyleText" class="text-xs text-cyan-400"></p>
                         </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-1">Latar Tempat:</label>
                            <select id="locationSet" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm">
                                <option value="pantai_tropis">Pantai Tropis (Bali, Lombok)</option>
                                <option value="gunung_megah">Gunung Megah (Bromo)</option>
                                <option value="kota_metropolitan">Kota Metropolitan (Jakarta)</option>
                                <option value="desa_tradisional">Desa Tradisional</option>
                                <option value="situs_sejarah">Situs Sejarah</option>
                                <option value="pasar_lokal">Pasar Lokal / Kuliner</option>
                                <option value="hutan_hujan">Hutan Hujan</option>
                                <option value="spot_foto_unik">Spot Foto Unik</option>
                                <option value="custom_location">Custom...</option>
                            </select>
                            <input type="text" id="customLocationInput" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm mt-2 hidden" placeholder="Lokasi kustom...">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-1">Kamera:</label>
                            <select id="cameraStyleSet" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm">
                                <option value="standard_cinematic">Sinematik Standar</option>
                                <option value="fpv_drone_dive">Drone FPV</option>
                                <option value="ground_level_action_cam">Kamera Aksi</option>
                                <option value="satellite_zoom">Zoom Satelit</option>
                                <option value="dolly_zoom_vertigo">Dolly Zoom</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-1">Bahasa:</label>
                            <select id="narratorLanguageSet" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm">
                                <option value="no_narrator">Tanpa Narator</option>
                                <option value="Indonesian">Bahasa Indonesia</option>
                                <option value="English">English</option>
                                <option value="Javanese">Bahasa Jawa</option>
                                <option value="custom_language">Lainnya...</option>
                            </select>
                            <input type="text" id="customNarratorLanguageInput" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm mt-2 hidden" placeholder="Bahasa...">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-1">Suara:</label>
                            <select id="narratorVoiceSet" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm">
                                <option value="dialog_murni">Hanya Dialog</option>
                                <option value="pria_dewasa_ramah">Pria Dewasa (Ramah)</option>
                                <option value="wanita_dewasa_lembut">Wanita Dewasa (Lembut)</option>
                                <option value="anak_laki_laki_ceria">Anak Laki-laki (Ceria)</option>
                                <option value="anak_perempuan_semangat">Anak Perempuan (Semangat)</option>
                                <option value="narator_dokumenter_berwibawa">Narator Dokumenter</option>
                                <option value="suara_robot_informatif">Suara Robot</option>
                            </select>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="w-full md:w-2/3 lg:w-3/4 glass-card">
                <div id="tabsContainer" class="border-b border-gray-700 flex">
                    <button id="tabNaskah" class="tab-btn active font-semibold py-3 px-5">Naskah</button>
                    <button id="tabStoryboard" class="tab-btn font-semibold py-3 px-5">Storyboard</button>
                </div>

                <div id="naskahView" class="p-6 space-y-6">
                    <div>
                        <label class="block mb-2 font-semibold text-gray-300">Judul / Topik:</label>
                        <div class="flex items-center gap-2">
                            <input id="projectTitleInput" type="text" placeholder="Contoh: 3 Hari di Jogja" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3">
                            <button id="generateScriptBtn" class="btn btn-ai font-semibold py-3 px-4 rounded-lg text-sm hidden flex items-center gap-2">
                                <span id="generateScriptBtnText">Buat Naskah</span>
                                <div id="scriptLoader" class="inline-loader hidden"></div>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold text-gray-300">Naskah Cerita:</label>
                        <textarea id="scenarioInput" rows="10" placeholder="Tulis naskah Anda di sini..." class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3"></textarea>
                    </div>
                     <div>
                        <label class="block mb-2 text-sm font-semibold text-gray-300">Jumlah Segmen:</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="sceneCount" min="1" max="20" value="3" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm">
                            <button id="analyzeTextBtn" class="btn btn-ai font-semibold py-2 px-4 rounded-lg text-sm">Analisis Teks</button>
                        </div>
                   </div>
                    <div class="border-t border-gray-700 pt-6 text-center">
                        <button id="generateBtn" class="btn btn-primary font-bold py-4 px-10 text-xl rounded-xl shadow-lg w-full" disabled>Buat Papan Cerita!</button>
                    </div>
                </div>

                <div id="storyboardView" class="p-6 hidden">
                    <div id="loader" class="mx-auto loader hidden"></div>
                    <div id="storyboardOutput" class="space-y-6 hidden"></div>
                    <div id="results-placeholder" class="flex flex-col items-center justify-center h-full text-center text-gray-500 py-20">
                        <p class="text-xl font-semibold">Hasil Papan Cerita Akan Muncul di Sini</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="characterModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h2 id="characterModalTitle" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-sky-400 mb-6 text-center futuristic-text-glow">Studio Host</h2>
            <div id="char-step1" class="flex-grow">
                 <p class="text-center text-gray-400 mb-4 text-sm">Langkah 1/3: Unggah referensi atau deskripsikan host.</p>
                 <input type="file" id="charImageInput" class="hidden" accept="image/*">
                 <div id="charImagePreview" class="w-full p-2 rounded-lg bg-gray-800 mb-4 flex items-center justify-center text-gray-500 min-h-[144px]"><span>Pratinjau Gambar</span></div>
                 <button id="uploadImageBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg w-full mb-4">Unggah Referensi</button>
                <textarea id="charIdeaInput" placeholder="Deskripsi host (Contoh: Wanita muda ceria, ransel, topi)" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3" rows="2"></textarea>
                <button id="developCharBtn" class="btn btn-ai font-semibold py-2 px-6 rounded-lg w-full mt-4 flex items-center justify-center gap-2">
                    <span id="developCharBtnText">‚ú® Desain Model</span>
                    <div id="charLoader" class="inline-loader hidden"></div>
                </button>
            </div>

            <div id="char-step2" class="hidden flex-grow overflow-y-auto pr-2">
                <p class="text-center text-gray-400 mb-4 text-sm">Langkah 2/3: Periksa detail host.</p>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-semibold text-gray-300">Nama:</label><input type="text" id="charBrandName" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3"></div>
                        <div><label class="block text-sm font-semibold text-gray-300">Peran:</label><input type="text" id="charModelName" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3"></div>
                    </div>
                    <div><label class="block text-sm font-semibold text-gray-300">ID Konsistensi:</label><input type="text" id="charConsistencyKey" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3"></div>
                    <div><label class="block text-sm font-semibold text-gray-300">Deskripsi Desain:</label><textarea id="charDesignLanguage" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3" rows="2"></textarea></div>
                </div>
            </div>

            <div id="char-step3" class="hidden flex-grow overflow-y-auto pr-2">
                <p class="text-center text-gray-400 mb-4 text-sm">Langkah 3/3: DNA Aksi.</p>
                <div><label class="block text-sm font-semibold text-gray-300 mb-2">Saran Aksi:</label><div id="actionDnaSuggestions" class="flex flex-wrap gap-2"></div></div>
                <div class="mt-4"><label class="block text-sm font-semibold text-gray-300 mb-1">Tambah Kustom:</label><div class="flex gap-2"><input type="text" id="customActionDnaInput" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm"><button id="addCustomDnaBtn" class="btn btn-secondary text-sm font-semibold py-2 px-3 rounded-lg">+</button></div></div>
                <div class="mt-4"><label class="block text-sm font-semibold text-gray-300 mb-2">Terpilih:</label><div id="selectedActionDna" class="flex flex-wrap gap-2 p-2 bg-gray-800/50 rounded-lg border border-cyan-500/50 min-h-[40px]"></div></div>
            </div>
            
            <div class="flex-shrink-0 pt-4 mt-4 border-t border-gray-700 flex justify-between items-center">
                 <button id="closeCharModalBtn" class="btn btn-secondary font-semibold py-2 px-6 rounded-lg">Tutup</button>
                 <div id="char-nav-buttons">
                     <button id="charPrevBtn" class="btn btn-secondary font-semibold py-2 px-6 rounded-lg hidden">Kembali</button>
                     <button id="charNextBtn" class="btn btn-primary font-semibold py-2 px-6 rounded-lg hidden">Lanjut</button>
                     <button id="addCharBtn" class="btn btn-success font-semibold py-2 px-6 rounded-lg hidden">‚úÖ Simpan</button>
                 </div>
            </div>
        </div>
    </div>
        
    <div id="settingsModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-sky-400 mb-2 text-center">Pengaturan</h2>
            <div>
                <label class="block text-sm font-semibold text-gray-300 mb-1">Google AI API Key</label>
                <input type="password" id="apiKeyInput" placeholder="API Key..." class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-3 text-sm">
                <p class="text-xs text-gray-500 mt-2"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-cyan-400 underline">Dapatkan key di sini</a>.</p>
            </div>
            <div class="mt-6 flex justify-between items-center pt-4 border-t border-gray-700">
                <button id="clearApiKeyBtn" class="btn btn-secondary text-sm font-semibold py-2 px-4 rounded-lg">Hapus</button>
                <div>
                    <button id="closeSettingsModalBtn" class="btn btn-secondary font-semibold py-2 px-6 rounded-lg mr-2">Tutup</button>
                    <button id="saveApiKeyBtn" class="btn btn-primary font-semibold py-2 px-6 rounded-lg">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationModal" class="fixed bottom-5 right-5 bg-gradient-to-r from-cyan-500 to-sky-500 text-white py-3 px-5 rounded-lg shadow-2xl hidden fade-in max-w-sm"><p id="notificationText"></p></div>

    <div id="confirmationModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3 id="confirmationTitle" class="text-xl font-bold mb-4">Konfirmasi</h3>
            <p id="confirmationMessage" class="text-gray-300 mb-6">Yakin?</p>
            <div class="flex justify-end gap-4"><button id="confirmCancelBtn" class="btn btn-secondary rounded-lg px-4 py-2">Batal</button><button id="confirmOkBtn" class="btn btn-primary rounded-lg px-4 py-2">OK</button></div>
        </div>
    </div>
    
    <input type="file" id="importFileInput" class="hidden" accept=".json">

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // State & Data
        let characters = []; let storyboardData = []; let userApiKey = '';
        let currentCharacterModalStep = 1; let isEditingCharacter = false; let editingCharacterIndex = -1;
        let uploadedImageBase64 = null; let uploadedImageType = null;

        const templateCharacters = [
            { name: "Rian (Host Petualang)", brandName: "Rian", modelName: "Host Petualang", description: "Pria muda, gaya chibi 3D, topi petualang, kemeja flanel.", consistency_key: "chibi_host_rian_v1", actionDNA: ["Menunjuk", "Takjub", "Berjalan"] },
            { name: "Sari (Host Kuliner)", brandName: "Sari", modelName: "Host Kuliner", description: "Wanita, gaya chibi 3D, jilbab cerah, celemek.", consistency_key: "chibi_host_sari_v1", actionDNA: ["Mencicipi", "Enak!", "Senyum"] }
        ];

        const BLOGGER_STYLE_KEYWORDS = { style: "Bright cinematic travel vlog style, cute 3D animated host (chibi style), informative graphic overlays, golden hour lighting, drone shots, 8K", negative: "dull, dark, grainy, shaky, fantasy, scary, ugly, deformed, watermark" };
        const defaultState = { projectTitle: '', scenario: '', sceneCount: 3, locationSet: 'pantai_tropis', customLocation: '', cameraStyleSet: 'standard_cinematic', narratorVoiceSet: 'pria_dewasa_ramah' };
        let state = { ...defaultState };

        // Elements
        const els = {
            projectTitle: document.getElementById('projectTitleInput'), generateScriptBtn: document.getElementById('generateScriptBtn'), generateScriptBtnText: document.getElementById('generateScriptBtnText'), scriptLoader: document.getElementById('scriptLoader'),
            charList: document.getElementById('charListContainer'), templateList: document.getElementById('templateCharList'), scenario: document.getElementById('scenarioInput'), sceneCount: document.getElementById('sceneCount'),
            analyzeBtn: document.getElementById('analyzeTextBtn'), generateBtn: document.getElementById('generateBtn'), storyboardOut: document.getElementById('storyboardOutput'), loader: document.getElementById('loader'), placeholder: document.getElementById('results-placeholder'),
            locSet: document.getElementById('locationSet'), custLoc: document.getElementById('customLocationInput'), camSet: document.getElementById('cameraStyleSet'), langSet: document.getElementById('narratorLanguageSet'), custLang: document.getElementById('customNarratorLanguageInput'), voiceSet: document.getElementById('narratorVoiceSet'), styleText: document.getElementById('selectedNarratorStyleText'),
            charModal: document.getElementById('characterModal'), charModalTitle: document.getElementById('characterModalTitle'), openCharModal: document.getElementById('openAddCharModalBtn'),
            step1: document.getElementById('char-step1'), step2: document.getElementById('char-step2'), step3: document.getElementById('char-step3'),
            devCharBtn: document.getElementById('developCharBtn'), devCharText: document.getElementById('developCharBtnText'), charLoader: document.getElementById('charLoader'),
            addCharBtn: document.getElementById('addCharBtn'), closeCharBtn: document.getElementById('closeCharModalBtn'), prevCharBtn: document.getElementById('charPrevBtn'), nextCharBtn: document.getElementById('charNextBtn'),
            brandName: document.getElementById('charBrandName'), modelName: document.getElementById('charModelName'), consistency: document.getElementById('charConsistencyKey'), design: document.getElementById('charDesignLanguage'),
            dnaSugg: document.getElementById('actionDnaSuggestions'), custDna: document.getElementById('customActionDnaInput'), addDnaBtn: document.getElementById('addCustomDnaBtn'), selDna: document.getElementById('selectedActionDna'),
            imgInput: document.getElementById('charImageInput'), uploadBtn: document.getElementById('uploadImageBtn'), imgPrev: document.getElementById('charImagePreview'), ideaInput: document.getElementById('charIdeaInput'),
            tabNaskah: document.getElementById('tabNaskah'), tabBoard: document.getElementById('tabStoryboard'), viewNaskah: document.getElementById('naskahView'), viewBoard: document.getElementById('storyboardView'),
            resetBtn: document.getElementById('resetProjectBtn'), confirmModal: document.getElementById('confirmationModal'), confirmTitle: document.getElementById('confirmationTitle'), confirmMsg: document.getElementById('confirmationMessage'), okBtn: document.getElementById('confirmOkBtn'), cancelBtn: document.getElementById('confirmCancelBtn'),
            settingsBtn: document.getElementById('openSettingsBtn'), settingsModal: document.getElementById('settingsModal'), closeSettings: document.getElementById('closeSettingsModalBtn'), apiKey: document.getElementById('apiKeyInput'), saveKey: document.getElementById('saveApiKeyBtn'), clearKey: document.getElementById('clearApiKeyBtn'),
            exportBtn: document.getElementById('exportProjectBtn'), importBtn: document.getElementById('importProjectBtn'), importInput: document.getElementById('importFileInput')
        };

        // --- ROBUST API FUNCTION (AUTO-FALLBACK) ---
        const callGeminiAPI = async (prompt, schema = null, initialModel = 'gemini-1.5-flash', imageBase64 = null, imageType = null) => {
            const apiKey = userApiKey || "";
            
            // Daftar model untuk dicoba secara berurutan jika gagal
            const modelFallbackList = [
                'gemini-1.5-flash',
                'gemini-1.5-flash-001',
                'gemini-1.5-flash-latest',
                'gemini-1.5-pro',
                'gemini-1.5-pro-001',
                'gemini-pro'
            ];

            // Pastikan model awal ada di urutan pertama
            let modelsToTry = [initialModel, ...modelFallbackList.filter(m => m !== initialModel)];
            
            let lastError = null;

            for (const model of modelsToTry) {
                try {
                    // console.log(`Mencoba model: ${model}...`); // Debugging
                    let apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    
                    let parts = [{ text: prompt }];
                    if (imageBase64 && imageType) parts.unshift({ inlineData: { mimeType: imageType, data: imageBase64 } });
                    
                    let payload = { contents: [{ role: "user", parts: parts }] };
                    if (schema) payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };

                    let response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        // Jika error 404 (Not Found) atau 400 (Not Supported), lanjut ke model berikutnya
                        if (response.status === 404 || response.status === 400) {
                            throw new Error(`Model ${model} not found/supported.`);
                        }
                        // Jika error lain (misal API Key salah/Quota), stop dan lempar error
                        if (response.status === 429) { throw new Error("Rate limit exceeded."); }
                        throw new Error(errData.error?.message || "API Error");
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (!candidate) throw new Error("No candidates returned.");
                    if (candidate.finishReason && candidate.finishReason !== 'STOP') throw new Error(`Stopped: ${candidate.finishReason}`);
                    
                    const text = candidate.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Empty response.");
                    
                    return text; // Berhasil!

                } catch (error) {
                    lastError = error;
                    // Lanjut ke model berikutnya dalam loop
                }
            }
            
            // Jika semua model gagal
            throw new Error(`Semua model gagal. Error terakhir: ${lastError.message}`);
        };
        
        // --- UI Logic ---
        const notify = (text) => {
            const m = document.getElementById('notificationModal'); document.getElementById('notificationText').textContent = text;
            m.classList.remove('hidden'); setTimeout(() => m.classList.add('hidden'), 4000);
        };
        const confirmAction = (t, m) => new Promise(res => {
            els.confirmTitle.textContent = t; els.confirmMsg.textContent = m; els.confirmModal.classList.add('visible');
            els.okBtn.onclick = () => { els.confirmModal.classList.remove('visible'); res(true); };
            els.cancelBtn.onclick = () => { els.confirmModal.classList.remove('visible'); res(false); };
        });
        const updateUI = () => els.generateBtn.disabled = !(state.scenario.trim());
        
        const renderChars = () => {
            els.charList.innerHTML = characters.length ? '' : '<p class="text-gray-500 italic text-sm">Belum ada host.</p>';
            characters.forEach((c, i) => {
                els.charList.innerHTML += `<div class="bg-gray-800/50 p-3 rounded-lg flex justify-between fade-in">
                    <div><p class="font-bold text-cyan-400">${c.name}</p><p class="text-xs text-gray-400">${c.modelName}</p></div>
                    <div class="flex gap-2"><button onclick="editChar(${i})" class="text-cyan-400">‚úé</button><button onclick="delChar(${i})" class="text-red-500">üóë</button></div>
                </div>`;
            });
        };
        window.editChar = (i) => {
            const c = characters[i]; isEditingCharacter = true; editingCharacterIndex = i;
            els.charModalTitle.textContent = "Sunting Host"; els.addCharBtn.textContent = "Perbarui";
            els.brandName.value = c.brandName; els.modelName.value = c.modelName; els.consistency.value = c.consistency_key; els.design.value = c.description;
            els.selDna.innerHTML = ''; c.actionDNA.forEach(d => addDna(d));
            els.charModal.classList.add('visible'); switchStep(2);
        };
        window.delChar = async (i) => { if(await confirmAction("Hapus?", "Yakin?")) { characters.splice(i,1); renderChars(); } };

        const renderTemplates = () => {
            els.templateList.innerHTML = '';
            templateCharacters.forEach((c, i) => {
                const btn = document.createElement('button'); btn.className = 'btn btn-ai text-xs px-3 py-1 rounded-md'; btn.textContent = 'Tambah';
                btn.onclick = () => { if(!characters.some(x=>x.name===c.name)) { characters.push({...c}); renderChars(); notify("Ditambahkan!"); } };
                const div = document.createElement('div'); div.className = 'bg-gray-800/60 p-3 rounded-lg flex justify-between items-center';
                div.innerHTML = `<div><p class="font-bold text-cyan-400 text-sm">${c.brandName}</p></div>`; div.appendChild(btn);
                els.templateList.appendChild(div);
            });
        };

        const renderBoard = (data) => {
            els.storyboardOut.innerHTML = '';
            if(!data || !data.length) { els.placeholder.classList.remove('hidden'); els.storyboardOut.classList.add('hidden'); return; }
            els.placeholder.classList.add('hidden'); els.storyboardOut.classList.remove('hidden');
            data.forEach((s, i) => {
                const div = document.createElement('div'); div.className = 'bg-gray-800/50 border border-gray-700 p-4 rounded-xl fade-in mb-4';
                div.innerHTML = `
                <div class="flex gap-4"><div class="bg-gray-700 text-cyan-400 font-bold rounded-lg w-12 h-12 flex items-center justify-center text-xl">${s.scene_number}</div>
                <div class="w-full"><h4 class="text-lg font-bold text-cyan-400">${s.scene_title}</h4><p class="text-gray-300 text-sm">${s.scene_summary}</p>
                <div class="mt-2 pt-2 border-t border-gray-700 grid grid-cols-2 gap-2 text-sm">
                    <div><p class="text-cyan-400 font-semibold">üé• Visual</p><p class="text-gray-400 italic">${s.cinematography?.shot_type}</p></div>
                    <div><p class="text-cyan-400 font-semibold">üîä Audio</p><p class="text-gray-400 italic">${s.sound_design?.narration_script || '-'}</p></div>
                </div>
                <div class="mt-3 flex gap-2 flex-wrap">
                    <button onclick="genPrompt(this, ${i}, 'blueprint')" class="btn btn-secondary text-xs py-1 px-3 rounded">Detail Prompt</button>
                    <button onclick="genPrompt(this, ${i}, 'canva')" class="btn btn-prompt-canva text-xs py-1 px-3 rounded">Canva Prompt</button>
                </div><div class="res-container mt-2"></div></div></div>`;
                els.storyboardOut.appendChild(div);
            });
        };

        // --- Logic ---
        els.generateScriptBtn.onclick = async () => {
            if(!els.projectTitle.value.trim()) return notify("Isi judul dulu.");
            els.generateScriptBtn.disabled = true; els.scriptLoader.classList.remove('hidden');
            try {
                const prompt = `Buat naskah vlog travel pendek, seru, informatif tentang "${els.projectTitle.value}". 3 paragraf (Pembuka, Isi, Penutup). Bahasa santai.`;
                const res = await callGeminiAPI(prompt); els.scenario.value = res; state.scenario = res; updateUI(); notify("Naskah siap!");
                els.sceneCount.value = Math.max(1, Math.ceil(res.split(/\s+/).length / 25));
            } catch(e) { notify(e.message); } finally { els.generateScriptBtn.disabled = false; els.scriptLoader.classList.add('hidden'); }
        };

        els.generateBtn.onclick = async () => {
            els.loader.classList.remove('hidden'); els.storyboardOut.classList.add('hidden'); switchTab(els.tabBoard, els.viewBoard);
            try {
                const charCtx = characters.map(c => `${c.name}: ${c.description}`).join('; ');
                const prompt = `Buat storyboard JSON (${els.sceneCount.value} segmen) dari naskah: "${state.scenario}". 
                Gaya: Vlog Travel Sinematik, Host Chibi 3D. Host: ${charCtx}. Lokasi: ${els.locSet.value}.
                Schema: { storyboard: [ { scene_number, scene_title, scene_summary, cinematography: { shot_type }, sound_design: { narration_script } } ] }`;
                const res = await callGeminiAPI(prompt, { type: "OBJECT", properties: { storyboard: { type: "ARRAY", items: { type: "OBJECT", properties: { scene_number: {type:"NUMBER"}, scene_title: {type:"STRING"}, scene_summary: {type:"STRING"}, cinematography: {type:"OBJECT", properties: {shot_type: {type:"STRING"}}}, sound_design: {type:"OBJECT", properties: {narration_script: {type:"STRING"}}} } } } }, required: ["storyboard"] });
                storyboardData = JSON.parse(res).storyboard; renderBoard(storyboardData);
            } catch(e) { els.storyboardOut.innerHTML = `<p class="text-red-400 text-center">Error: ${e.message}</p>`; els.storyboardOut.classList.remove('hidden'); } finally { els.loader.classList.add('hidden'); }
        };

        window.genPrompt = async (btn, idx, type) => {
            const container = btn.closest('div').parentElement.querySelector('.res-container');
            btn.disabled = true; btn.innerText = '...';
            try {
                const scn = storyboardData[idx];
                let p = "";
                if (type === 'blueprint') p = `Generate detailed video prompt (English) for: ${scn.scene_summary}. Style: ${BLOGGER_STYLE_KEYWORDS.style}. Character info: Consistent ID available.`;
                else p = `Buat prompt Canva Magic Media (Bahasa Indo) untuk: ${scn.scene_summary}. Gaya: Vlog Travel Chibi 3D.`;
                const res = await callGeminiAPI(p);
                container.innerHTML = `<div class="bg-gray-900 p-2 rounded mt-2 border border-gray-700 text-xs font-mono whitespace-pre-wrap">${res}</div>`;
            } catch(e) { notify(e.message); } finally { btn.disabled = false; btn.innerText = type === 'blueprint' ? 'Detail Prompt' : 'Canva Prompt'; }
        };

        els.devCharBtn.onclick = async () => {
            const desc = els.ideaInput.value; if(!desc && !uploadedImageBase64) return notify("Isi deskripsi/gambar.");
            els.devCharBtn.disabled = true; els.charLoader.classList.remove('hidden');
            try {
                const p = `Create JSON character profile for travel vlog host. Input: "${desc}". Style: Cute 3D Chibi. Schema: { brand_name, model_name, design_language, consistency_key }`;
                const res = await callGeminiAPI(p, { type: "OBJECT", properties: { brand_name: {type:"STRING"}, model_name: {type:"STRING"}, design_language: {type:"STRING"}, consistency_key: {type:"STRING"} } }, 'gemini-1.5-flash', uploadedImageBase64, uploadedImageType);
                const d = JSON.parse(res); els.brandName.value = d.brand_name; els.modelName.value = d.model_name; els.design.value = d.design_language; els.consistency.value = d.consistency_key; switchStep(2);
            } catch(e) { notify(e.message); } finally { els.devCharBtn.disabled = false; els.charLoader.classList.add('hidden'); }
        };

        // Helpers & Inits
        const switchTab = (t, v) => { [els.tabNaskah, els.tabBoard].forEach(x=>x.classList.remove('active')); [els.viewNaskah, els.viewBoard].forEach(x=>x.classList.add('hidden')); t.classList.add('active'); v.classList.remove('hidden'); };
        const switchStep = (s) => { 
            [els.step1, els.step2, els.step3].forEach(x=>x.classList.add('hidden')); 
            [els.prevCharBtn, els.nextCharBtn, els.addCharBtn].forEach(x=>x.classList.add('hidden'));
            if(s===1) { els.step1.classList.remove('hidden'); }
            else if(s===2) { els.step2.classList.remove('hidden'); els.prevCharBtn.classList.remove('hidden'); els.nextCharBtn.classList.remove('hidden'); }
            else { els.step3.classList.remove('hidden'); els.prevCharBtn.classList.remove('hidden'); els.addCharBtn.classList.remove('hidden'); }
            currentCharacterModalStep = s;
        };
        const addDna = (t) => { const s = document.createElement('span'); s.className = 'action-dna-tag selected bg-cyan-600 text-white px-2 py-1 rounded text-xs m-1'; s.textContent = t; s.onclick = () => s.remove(); els.selDna.appendChild(s); };
        
        // Listeners
        els.uploadBtn.onclick = () => els.imgInput.click();
        els.imgInput.onchange = (e) => { const f = e.target.files[0]; const r = new FileReader(); r.onload = (ev) => { els.imgPrev.innerHTML = `<img src="${ev.target.result}" class="h-full object-contain">`; uploadedImageBase64 = ev.target.result.split(',')[1]; uploadedImageType = f.type; }; r.readAsDataURL(f); };
        els.addCharBtn.onclick = () => { 
            if(!els.brandName.value) return notify("Nama wajib.");
            const c = { name: els.brandName.value, brandName: els.brandName.value, modelName: els.modelName.value, description: els.design.value, consistency_key: els.consistency.value, actionDNA: [] };
            if(isEditingCharacter) characters[editingCharacterIndex] = c; else characters.push(c);
            renderChars(); els.charModal.classList.remove('visible');
        };
        els.addDnaBtn.onclick = () => { if(els.custDna.value) { addDna(els.custDna.value); els.custDna.value = ''; } };
        els.openCharModal.onclick = () => { isEditingCharacter = false; els.ideaInput.value = ''; els.imgPrev.innerHTML = 'Preview'; uploadedImageBase64 = null; switchStep(1); els.charModal.classList.add('visible'); };
        els.closeCharBtn.onclick = () => els.charModal.classList.remove('visible');
        els.nextCharBtn.onclick = () => switchStep(3); els.prevCharBtn.onclick = () => switchStep(currentCharacterModalStep - 1);
        
        els.tabNaskah.onclick = () => switchTab(els.tabNaskah, els.viewNaskah); els.tabBoard.onclick = () => switchTab(els.tabBoard, els.viewBoard);
        els.analyzeBtn.onclick = () => els.sceneCount.value = Math.max(1, Math.ceil(els.scenario.value.split(/\s+/).length / 25));
        els.settingsBtn.onclick = () => els.settingsModal.classList.add('visible'); els.closeSettings.onclick = () => els.settingsModal.classList.remove('visible');
        els.saveKey.onclick = () => { userApiKey = els.apiKey.value; localStorage.setItem('ws_key', userApiKey); notify("Tersimpan"); els.settingsModal.classList.remove('visible'); };
        els.clearKey.onclick = () => { userApiKey = ''; els.apiKey.value = ''; localStorage.removeItem('ws_key'); notify("Dihapus"); };
        els.projectTitle.oninput = (e) => { state.projectTitle = e.target.value; els.generateScriptBtn.classList.toggle('hidden', !e.target.value); };
        els.scenario.oninput = (e) => { state.scenario = e.target.value; updateUI(); };
        els.resetBtn.onclick = async () => { if(await confirmAction("Reset?", "Semua data hilang.")) { state = {...defaultState}; characters = []; storyboardData = []; renderChars(); renderBoard([]); els.projectTitle.value = ''; els.scenario.value = ''; updateUI(); } };

        // Init
        userApiKey = localStorage.getItem('ws_key') || ''; els.apiKey.value = userApiKey;
        renderTemplates(); renderChars(); updateUI();
    });
    </script>
</body>
</html>
